<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="simbuerg">
  <link rel="canonical" href="https://polyjit.github.io/benchbuild/basics/containers/">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Containers - BenchBuild</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  <link href="//use.fontawesome.com/releases/v5.8.1/css/all.css" rel="stylesheet" />
  <link href="//use.fontawesome.com/releases/v5.8.1/css/v4-shims.css" rel="stylesheet" />
  <link href="../../css/pheasant.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Containers";
    var mkdocs_page_input_path = "basics/containers.md";
    var mkdocs_page_url = "/benchbuild/basics/containers/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> BenchBuild</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">BenchBuild Documentation</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Getting Started</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../">Installation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../configuration/">Configuration</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Containers</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#replace-images">Replace Images</a>
    </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Concepts</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../concepts/source/">Source</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../concepts/environments/">Environment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../concepts/projects/">Project</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../concepts/experiments/">Experiment</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Advanced Usage</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced/">SLURM</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">About</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG/">Release Notes</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">BenchBuild</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Getting Started &raquo;</li>
        
      
    
    <li>Containers</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                
<p>Benchbuild allows the definition of container images to define the base system
all experiment runs run in for a given project.</p>
<h2 id="usage">Usage</h2>
<p>If you want to run an experiment inside the project's container, simply replace
the usual <code>run</code> subcommand with the <code>container run</code> subcommand. Project and
experiment selection are done in the same way.</p>
<p>Example:</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="">benchbuild container run -E raw linpack</code></pre></div>
<div class="report"><p><span class="count">[1]</span>
<span class="start"></span> (<span class="time"></span>)
<span class="right"><span class="kernel"></span> (<span class="total"></span>)</span></p></div></div></div></div>

<p>This will run the following stages:</p>
<ol>
<li>Build all necessary base images.
     All images are initiated from a base image. Benchbuild knows how to construct
     a few base images. These will be prepared with all dependencies required to
     run benchbuild inside the container.</li>
<li>Build all project images. Each project has to define its' own image.</li>
<li>Build the experiment images. Each experiment can add anything it needs to the
     project images, if required. Use this to bring tools into the image that do
     not require any knowledge about the environment to run properly.
     For anything else, consider using a custom base image.</li>
</ol>
<h3 id="replace-images">Replace Images</h3>
<p>Benchbuild will reuse any existing images it can find in your image registry.
The only relevant information is the image tag, e.g., <code>benchbuild:alpine</code>.
If you want to avoid reuse and force to rebuild images unconditionally, you can
use the <code>--replace</code> flag when running the <code>containers</code> subcommand.</p>
<p>Example:</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="">benchbuild container run --replace -E raw linpack</code></pre></div>
<div class="report"><p><span class="count">[2]</span>
<span class="start"></span> (<span class="time"></span>)
<span class="right"><span class="kernel"></span> (<span class="total"></span>)</span></p></div></div></div></div>

<p>This will ignore <strong>any</strong> required image for the given experiments and projects.</p>
<h2 id="configuration">Configuration</h2>
<p>You can configure the container environment using the following config variables.</p>
<ul>
<li><code>BB_CONTAINER_EXPORT</code>: Path where benchbuild stores exported container
  images. By default we store it in <code>./containers/export</code>. Will be created
  automatically, if needed.</li>
<li><code>BB_CONTAINER_IMPORT</code>: Path where to input images from into the registry.
  By default we load from <code>./containers/export</code>.</li>
<li><code>BB_CONTAINER_FROM_SOURCE</code>: Determine, if we should use benchbuild from the
  current source checkout, or from pip.</li>
<li><code>BB_CONTAINER_ROOT</code>: Where we store our image layers. This is the image
  registry. Cannot be stored on filesystems that do not support subuid/-gid
  mapping, e.g. NFS.
  The default location is <code>./containers/lib</code>.</li>
<li><code>BB_CONTAINER_RUNROOT</code>: Where we store temporary image layers of running
  containers. See <code>BB_CONTAINER_ROOT</code> for restrictions.
  The default location is: <code>./containers/run</code>.</li>
<li><code>BB_CONTAINER_RUNTIME</code>: Podman can use any standard OCI-container runtime to
  launch containers. We use <a href="https://github.com/containers/crun">crun</a> by
  default. Depending on your system, this one has already been installed with
  <code>podman</code>.
  The default runtime is: <code>/usr/bin/crun</code></li>
<li><code>BB_CONTAINER_MOUNTS</code>: A list of mountpoint definitions that should be added
  to all containers. With this you can add arbitrary tools into all containers.
  Default: <code>[]</code></li>
</ul>
<h2 id="definition">Definition</h2>
<p>A project that wants to use a container image needs to define it in the
<code>CONTAINER</code> attribute it using our declarative API provided by
<code>benchbuild.environments.domain.declarative</code>.</p>
<div class="pheasant-fenced-code"><div class="cached"><div class="cell jupyter input"><div class="code"><pre><code class="">from benchbuild.environments.domain.declarative import ContainerImage

class Testproject(Project):
  CONTAINER = ContainerImage().from_(&#39;benchbuild:alpine&#39;)</code></pre></div>
<div class="report"><p><span class="count">[3]</span>
<span class="start"></span> (<span class="time"></span>)
<span class="right"><span class="kernel"></span> (<span class="total"></span>)</span></p></div></div></div></div>

<p>The available set of commands follows the structure of a <code>Dockerfile</code>.</p>
<h2 id="runtime-requirements">Runtime requirements</h2>
<p>For containers to work properly, you need a few systems set up beforehand.</p>
<h3 id="buildah">Buildah</h3>
<p>Image construction requires the <a href="https://buildah.io">Buildah</a> tool. All image
construction tasks are formulated as buildah command calls in the backend.</p>
<p>Buildah is supported up to version 1.19.8.</p>
<h3 id="podman">Podman</h3>
<p>Container construction and execution is handed off to <a href="https://podman.io">Podman</a>.
Podman provides rootless containers and does not requires the execution of a
daemon process. However, you need to setup your user namespace properly to allow
mapping of subordinate uids/gids. Otherwise, podman will not be able to map
users other than the root user to filesystem permissions inside the container.</p>
<p>Please refer to podman's documentation on how to setup podman properly on your
system.</p>
<p>Podman is supported up to version 2.2.1</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../concepts/source/" class="btn btn-neutral float-right" title="Source">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../configuration/" class="btn btn-neutral" title="Configuration"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/PolyJIT/benchbuild" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../configuration/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../concepts/source/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../js/pheasant.js"></script>
      <script src="../../search/main.js"></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
